<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexoqzf</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-06-05T13:54:05.125Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>qzf</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>评论插件--gitalk</title>
    <link href="http://yoursite.com/2020/06/05/hexo/%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6--gitalk/"/>
    <id>http://yoursite.com/2020/06/05/hexo/%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6--gitalk/</id>
    <published>2020-06-04T16:00:00.000Z</published>
    <updated>2020-06-05T13:54:05.125Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/gitalk/gitalk">gitalk</a> 是一个基于 Github Issue 和 Preact 开发的评论插件。它除了支持 Hexo 外，还支持 java，php 等语言开发的博客 。</p><a id="more"></a><p>使用方法:</p><p>1.首先到GitHub上去新建一个仓库用于存放评论的内容 。</p><p><img src="https://raw.githubusercontent.com/myqzf/blog_img/master/img/develop/blog1.png" alt=""></p><p>2.在设置中打开isue功能 </p><p><img src="https://raw.githubusercontent.com/myqzf/blog_img/master/img/develop/bolg2.png" alt=""></p><p>3.注册一个Github Application </p><p>(1) 申请地址:<a href="https://github.com/settings/applications/new">https://github.com/settings/applications/new</a>  </p><p><img src="https://raw.githubusercontent.com/myqzf/blog_img/master/img/develop/blob3.png" alt=""></p><p>名字随便写，描述随便写 ,<code>Authorization callback URL</code> 填写当前使用页面的域名 </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://github.com/gitalk/gitalk&quot;&gt;gitalk&lt;/a&gt; 是一个基于 Github Issue 和 Preact 开发的评论插件。它除了支持 Hexo 外，还支持 java，php 等语言开发的博客 。&lt;/p&gt;
    
    </summary>
    
    
      <category term="hexo" scheme="http://yoursite.com/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://yoursite.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>icarus主题部分配置使用</title>
    <link href="http://yoursite.com/2020/06/05/hexo/icarus%E4%B8%BB%E9%A2%98%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE/"/>
    <id>http://yoursite.com/2020/06/05/hexo/icarus%E4%B8%BB%E9%A2%98%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE/</id>
    <published>2020-06-04T16:00:00.000Z</published>
    <updated>2020-06-05T08:20:58.477Z</updated>
    
    <content type="html"><![CDATA[<h5 id="配置文章部分"><a href="#配置文章部分" class="headerlink" title="配置文章部分"></a>配置文章部分</h5><p>顶部图片添加</p><p>在主题中的配置<code>_config.yml</code>中开启图片开关</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">article:</span><br><span class="line">    thumbnail: true</span><br></pre></td></tr></table></figure><p>文章.md文件头添加图片绝对/相对地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">title: Getting Started with Icarus</span><br><span class="line">thumbnail: &#x2F;gallery&#x2F;thumbnails&#x2F;desert.jpg</span><br><span class="line">&#x2F;&#x2F; thumbnail:https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;removeif&#x2F;blog_image&#x2F;20190620152744.png</span><br><span class="line">---</span><br><span class="line">Post content...</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h5 id=&quot;配置文章部分&quot;&gt;&lt;a href=&quot;#配置文章部分&quot; class=&quot;headerlink&quot; title=&quot;配置文章部分&quot;&gt;&lt;/a&gt;配置文章部分&lt;/h5&gt;&lt;p&gt;顶部图片添加&lt;/p&gt;
&lt;p&gt;在主题中的配置&lt;code&gt;_config.yml&lt;/code&gt;中开启图片开关&lt;/
      
    
    </summary>
    
    
      <category term="hexo" scheme="http://yoursite.com/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://yoursite.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>前端文件更新方案</title>
    <link href="http://yoursite.com/2020/05/23/Jenkins/%E5%89%8D%E7%AB%AF%E6%96%87%E4%BB%B6%E6%9B%B4%E6%96%B0%E6%96%B9%E6%A1%88/"/>
    <id>http://yoursite.com/2020/05/23/Jenkins/%E5%89%8D%E7%AB%AF%E6%96%87%E4%BB%B6%E6%9B%B4%E6%96%B0%E6%96%B9%E6%A1%88/</id>
    <published>2020-05-22T16:00:00.000Z</published>
    <updated>2020-06-05T08:26:38.652Z</updated>
    
    <content type="html"><![CDATA[<p>前端文件(除index.html在服务器nginx下)存储在七牛中。</p><p>通过samba进行各项目前端文件的暂存。之后由jenkins各项目分别调取，然后上传至七牛及服务器。</p><p>jenkins相关配置</p><p><img src="https://image.suning.cn/uimg/ZR/share_order/159021459572363946.jpg" alt=""></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">QINIUPREFIX=xaxy  <span class="comment">#七牛前缀</span></span><br><span class="line">FILE_DIR=/ssdb2/share/front/qiniu/xaxy</span><br><span class="line"></span><br><span class="line">UNPACK_DIR=<span class="variable">$FILE_DIR</span>/unpack   <span class="comment">#解压输出目录</span></span><br><span class="line">PROJECT_DIR=<span class="variable">$WORKSPACE</span>/<span class="variable">$QINIUPREFIX</span>  <span class="comment">#上传文件目录</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$FILE_DIR</span></span><br><span class="line">zipCnt=`ls -l |grep <span class="string">"^-"</span>|wc -l`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"zipCnt=<span class="variable">$zipCnt</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$zipCnt</span>"</span> -eq <span class="string">"1"</span> ];<span class="keyword">then</span></span><br><span class="line">   cp <span class="variable">$FILE_DIR</span>/* /ssdb2/share/front/backup/    <span class="comment">#备份</span></span><br><span class="line">   zipName=`find *.zip`</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"zipName=<span class="variable">$zipName</span>"</span></span><br><span class="line">   unzip <span class="variable">$zipName</span> -d <span class="variable">$UNPACK_DIR</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"压缩文件存在 <span class="variable">$zipCnt</span> 个，构建退出"</span></span><br><span class="line">   <span class="built_in">set</span> -e <span class="comment">#注意，一定要先设置这个</span></span><br><span class="line">   <span class="built_in">exit</span> 1  <span class="comment">#然后再退出，jenkins就会报红显示构建失败</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$WORKSPACE</span></span><br><span class="line">rm -r <span class="variable">$PROJECT_DIR</span>/</span><br><span class="line">mkdir <span class="variable">$PROJECT_DIR</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$UNPACK_DIR</span>/*/</span><br><span class="line">cp -r ./ <span class="variable">$PROJECT_DIR</span></span><br><span class="line">rm -r <span class="variable">$FILE_DIR</span>/*     <span class="comment">#清空目录，注意：删除高危操作！！！！</span></span><br></pre></td></tr></table></figure><p><img src="https://image.suning.cn/uimg/ZR/share_order/159021517887493234.jpg" alt=""></p><p>文件路径填写七牛前缀名。</p><p>要上传到的 bucket填写要上传至七牛空间名</p><p>下面是把index.html上传至的服务器目录。</p><p>由于项目是在太多，更新上传前端很多时非常费时，又容易出差错。</p><p>所以进行了改良，前端文件包名都带有(xx七牛前缀名)，所以把前端文件上传至统一目录，然后根据包上的前缀名，进行提取。</p><p><img src="https://image.suning.cn/uimg/ZR/share_order/159021577046034241.jpg" alt=""></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">QINIUPREFIX=<span class="variable">$qiniuPrefix</span> </span><br><span class="line">FILE_DIR=/ssdb2/share/front/update</span><br><span class="line">UNPACK_DIR=<span class="variable">$FILE_DIR</span>/unpack/<span class="variable">$QINIUPREFIX</span>   <span class="comment">#解压输出目录</span></span><br><span class="line">PROJECT_DIR=<span class="variable">$WORKSPACE</span>/<span class="variable">$QINIUPREFIX</span>  <span class="comment">#上传文件目录</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$FILE_DIR</span></span><br><span class="line">zipCnt=`find *<span class="variable">$QINIUPREFIX</span>*.zip |wc -l`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$zipCnt</span>"</span> -eq <span class="string">"1"</span> ];<span class="keyword">then</span></span><br><span class="line">   zipName=`find *<span class="variable">$QINIUPREFIX</span>*.zip`</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"zipName=<span class="variable">$zipName</span>"</span></span><br><span class="line">   mkdir -p <span class="variable">$UNPACK_DIR</span></span><br><span class="line">   unzip <span class="variable">$zipName</span> -d <span class="variable">$UNPACK_DIR</span></span><br><span class="line">   mv <span class="variable">$FILE_DIR</span>/<span class="variable">$zipName</span> /ssdb2/share/front/backup/    <span class="comment">#备份</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"压缩文件存在 <span class="variable">$zipCnt</span> 个，构建退出"</span></span><br><span class="line">   <span class="built_in">set</span> -e <span class="comment">#注意，一定要先设置这个</span></span><br><span class="line">   <span class="built_in">exit</span> 1  <span class="comment">#然后再退出，jenkins就会报红显示构建失败</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$WORKSPACE</span></span><br><span class="line">rm -r <span class="variable">$PROJECT_DIR</span>/</span><br><span class="line">mkdir <span class="variable">$PROJECT_DIR</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$UNPACK_DIR</span>/*/</span><br><span class="line">cp -r ./ <span class="variable">$PROJECT_DIR</span></span><br><span class="line">rm -r <span class="variable">$UNPACK_DIR</span>/*   <span class="comment">#清空目录，注意：删除高危操作！！！！</span></span><br><span class="line"><span class="comment">##rm -r $FILE_DIR/*</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前端文件(除index.html在服务器nginx下)存储在七牛中。&lt;/p&gt;
&lt;p&gt;通过samba进行各项目前端文件的暂存。之后由jenkins各项目分别调取，然后上传至七牛及服务器。&lt;/p&gt;
&lt;p&gt;jenkins相关配置&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://
      
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/categories/Jenkins/"/>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>echo-nginx-module模块</title>
    <link href="http://yoursite.com/2020/04/29/nginx/echo-nginx-module%E6%A8%A1%E5%9D%97/"/>
    <id>http://yoursite.com/2020/04/29/nginx/echo-nginx-module%E6%A8%A1%E5%9D%97/</id>
    <published>2020-04-28T16:00:00.000Z</published>
    <updated>2020-04-30T07:07:11.000Z</updated>
    
    <content type="html"><![CDATA[<p> 使用 Nginx Upload Module 实现上传文件功能</p><p>下载nginx及echo-nginx-module模块</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget http://nginx.org/download/nginx-1.16.1.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://github.com/openresty/<span class="built_in">echo</span>-nginx-module/archive/v0.61.tar.gz</span></span><br></pre></td></tr></table></figure><p>编译执行nginx</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/usr/<span class="built_in">local</span>/nginx --with-http_ssl_module --add-module=/usr/<span class="built_in">local</span>/src/nginx/<span class="built_in">echo</span>-nginx-module-0.61 --add-module=/usr/<span class="built_in">local</span>/src/nginx/nginx-upload-module-2.3.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --with-http_ssl_module  开启SSL模块   --add-module添加附加模块   nginx_upload_module模块</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make install  <span class="comment">#注意如果之前安装过，不要make install</span></span></span><br></pre></td></tr></table></figure><p>配置</p><p>nginx-upload.conf</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#echo-nginx-module module</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">location</span> /sub &#123;</span><br><span class="line">           <span class="attribute">echo</span> <span class="string">"querystring: <span class="variable">$query_string</span>"</span>;</span><br><span class="line">           <span class="attribute">echo</span> <span class="string">"method: <span class="variable">$echo_request_method</span>"</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在浏览器请求 <a href="http://localhost/sub?name=11">http://localhost/sub?name=11</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#输出</span></span><br><span class="line">querystring: name=11</span><br><span class="line">method: GET</span><br></pre></td></tr></table></figure><p>如果请求后nginx把响应作为未知类型的文件保存，可以指定一下Content-Type： <code>default_type text/plain;</code></p><p>配置参数参考：<a href="https://github.com/openresty/echo-nginx-module/">echo-nginx-module</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt; 使用 Nginx Upload Module 实现上传文件功能&lt;/p&gt;
&lt;p&gt;下载nginx及echo-nginx-module模块&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pr
      
    
    </summary>
    
    
      <category term="nginx" scheme="http://yoursite.com/categories/nginx/"/>
    
    
      <category term="nginx" scheme="http://yoursite.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>nginx在请求路径中修改字符串</title>
    <link href="http://yoursite.com/2020/04/28/nginx/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/nginx%E5%9C%A8%E8%AF%B7%E6%B1%82%E8%B7%AF%E5%BE%84%E4%B8%AD%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <id>http://yoursite.com/2020/04/28/nginx/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/nginx%E5%9C%A8%E8%AF%B7%E6%B1%82%E8%B7%AF%E5%BE%84%E4%B8%AD%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E4%B8%B2/</id>
    <published>2020-04-27T16:00:00.000Z</published>
    <updated>2020-04-30T10:04:25.000Z</updated>
    
    <content type="html"><![CDATA[<p>nginx在请求路径后加字符串</p><p>需求一：<a href="http://192.168.1.113:8080/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a.m3u8，你能跟我转发给：http://192.168.1.113:8080/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a么？就是播放要认后缀名.m3u8，而我们系统没有用后缀。">http://192.168.1.113:8080/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a.m3u8，你能跟我转发给：http://192.168.1.113:8080/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a么？就是播放要认后缀名.m3u8，而我们系统没有用后缀。</a></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~* /playhls/(.*)</span>  &#123;</span><br><span class="line">              <span class="attribute">set</span> <span class="variable">$suffix</span> <span class="string">".m3u8"</span>;</span><br><span class="line">              <span class="attribute">if</span> (<span class="variable">$request_uri</span> !<span class="regexp">~*  /(.*)\.m3u8$)</span> &#123;</span><br><span class="line">                    <span class="attribute">rewrite</span> <span class="regexp"> ^/(.*)$</span>   http://<span class="variable">$server_name</span><span class="variable">$request_uri</span><span class="variable">$suffix</span>;</span><br><span class="line">                &#125;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/xiaoleiel/p/8308492.html">nginx$参数</a></p><p>需求二：把/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a.m3u8  转发到/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a</p><p>即前端要用playhls/xxx.m3u8，转到后台是playhls/xxx</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~* /playhls/(.*)</span>  &#123;</span><br><span class="line"><span class="attribute">if</span> (<span class="variable">$request_uri</span> <span class="regexp">~*  (/.*)\.m3u8$)</span> &#123;</span><br><span class="line">                     <span class="attribute">set</span> <span class="variable">$repath</span> <span class="variable">$1</span>;</span><br><span class="line">                     <span class="comment">#echo $repath;</span></span><br><span class="line">                     <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> <span class="variable">$repath</span> <span class="literal">break</span>;</span><br><span class="line">                     <span class="attribute">proxy_pass</span>    http://192.168.1.101:8088;</span><br><span class="line">                 <span class="comment"># rewrite  ^/(.*)$   http://$server_name$repath;</span></span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1、先用正则<code>(/.*)\.m3u8$</code>匹配到<code>/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a.m3u8</code></p><p>2、然后把括号中截取到的字符<code>/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a</code> 赋值给变量<code>$repath</code> , $1表示第一个括号内匹配的正则参数。</p><p>3、然后用<code>rewrite</code> 修改 $uri。</p><p>4、最后<code>proxy_pass</code>按路径<code>/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a</code>转发到 <code>http://192.168.1.101:8088</code></p><p>注意 rewrite 要有个重新匹配 location 的副作用。由于 proxy_pass 的处理阶段比 location 处理更晚，所以这里需要 break 掉，以防止 rewrite 进入下一次 location 匹配而丢失 proxy_pass。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;nginx在请求路径后加字符串&lt;/p&gt;
&lt;p&gt;需求一：&lt;a href=&quot;http://192.168.1.113:8080/cpnsp/ws/playhls/4f2ef26002aa4b0b8990e1503abe624a.m3u8，你能跟我转发给：http://192.1
      
    
    </summary>
    
    
      <category term="nginx" scheme="http://yoursite.com/categories/nginx/"/>
    
    
      <category term="nginx" scheme="http://yoursite.com/tags/nginx/"/>
    
      <category term="nginx配置" scheme="http://yoursite.com/tags/nginx%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>java服务CPU占用高</title>
    <link href="http://yoursite.com/2020/04/20/%E5%B7%A5%E4%BD%9C/java%E6%9C%8D%E5%8A%A1CPU%E5%8D%A0%E7%94%A8%E9%AB%98/"/>
    <id>http://yoursite.com/2020/04/20/%E5%B7%A5%E4%BD%9C/java%E6%9C%8D%E5%8A%A1CPU%E5%8D%A0%E7%94%A8%E9%AB%98/</id>
    <published>2020-04-19T16:00:00.000Z</published>
    <updated>2020-04-22T13:42:30.050Z</updated>
    
    <content type="html"><![CDATA[<p> 由上篇内存占用过高，未定位到准确的问题，今天某时段服务的CPU突然占用高，或许是引起内存占用的元凶。</p><p>①通过top找到占用cpu最高的 <strong>pid[进程id]</strong></p><p>通过Shift+P按CUP排序，定位到pid是 13748</p><p>②通过 <strong>top -Hp pid</strong> 查看进程中占用cpu过高的 <strong>tid[线程id]</strong></p><p><img src="https://pic.images.ac.cn/image/5e9da7a169a9f" alt=""></p><p>占用cpu过高的线程有五个，以其中一个线程做示例</p><p>③通过 <strong>printf  ‘%x/n’ tid</strong>  把线程id转化为十六进制</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">printf</span> <span class="string">'%x/n'</span> 13796</span></span><br><span class="line">35e4</span><br></pre></td></tr></table></figure><p>④通过 <strong>jstack pid | grep tid -A 50</strong> 定位线程堆栈信息</p><p><img src="https://pic.images.ac.cn/image/5e9da8122ba46" alt=""></p><p> ⑤ 根据堆栈信息就可以定位代码</p><p><img src="https://pic.images.ac.cn/image/5e9da8487fe17" alt=""></p><p>发现occupationIds进行了无限循环。</p><p>⑥同样把剩余的4个线程分析下也是此原因</p><p>之前通过dump线上环境的JVM内存进行分析，有此方法的影子，但是并不能完全确定。</p><p>在网上看到一个较快定位问题请求的方法(<a href="https://www.sohu.com/a/233984305_355142">JVM 堆内存使用率持续上升的一种排查思路</a>) ，直接在nginx日志中搜索响应码为504的请求，然后看日志时间是否与内存或CPU上升时间点吻合，分析504的请求，确认是否存在死循环。504响应码为网关超时，当一个请求到Tomcat后，tomcat如果陷入死循环，那么这个请求自然无法得到响应，nginx等待响应超时，响应给用户504。</p><p>参考：<a href="https://zhuanlan.zhihu.com/p/69342660">https://zhuanlan.zhihu.com/p/69342660</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt; 由上篇内存占用过高，未定位到准确的问题，今天某时段服务的CPU突然占用高，或许是引起内存占用的元凶。&lt;/p&gt;
&lt;p&gt;①通过top找到占用cpu最高的 &lt;strong&gt;pid[进程id]&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;通过Shift+P按CUP排序，定位到pid是 137
      
    
    </summary>
    
    
      <category term="工作" scheme="http://yoursite.com/categories/%E5%B7%A5%E4%BD%9C/"/>
    
    
      <category term="java" scheme="http://yoursite.com/tags/java/"/>
    
      <category term="工作" scheme="http://yoursite.com/tags/%E5%B7%A5%E4%BD%9C/"/>
    
      <category term="JVM" scheme="http://yoursite.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>java服务内存占用定位</title>
    <link href="http://yoursite.com/2020/04/19/%E5%B7%A5%E4%BD%9C/java%E6%9C%8D%E5%8A%A1%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E5%AE%9A%E4%BD%8D/"/>
    <id>http://yoursite.com/2020/04/19/%E5%B7%A5%E4%BD%9C/java%E6%9C%8D%E5%8A%A1%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E5%AE%9A%E4%BD%8D/</id>
    <published>2020-04-18T16:00:00.000Z</published>
    <updated>2020-05-09T02:07:39.000Z</updated>
    
    <content type="html"><![CDATA[<p> top部分交互命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c:  显示完整的命令</span><br><span class="line">d： 更改刷新频率</span><br><span class="line">P： 根据CPU资源使用大小进行排序</span><br><span class="line">M： 根据内存资源使用大小进行排序</span><br></pre></td></tr></table></figure><p> 通过jinfo查看JVM启动信息</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看内存占用，rsz为实际内存，单位kb</span></span><br><span class="line"><span class="comment"># ps -eo 'pid,rsz,vsz' |grep pid</span></span><br><span class="line">$ ps -eo <span class="string">'pid,rsz,vsz'</span> |grep 27843</span><br><span class="line">27843 1684668 12343528</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统信息</span></span><br><span class="line"><span class="comment"># jinfo -sysprops pid</span></span><br><span class="line">$ jinfo -sysprops 27843</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看JVM信息</span></span><br><span class="line"><span class="comment"># jinfo -flags pid</span></span><br><span class="line">$ jinfo -flags 27843</span><br><span class="line">Attaching to process ID 27843, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.231-b11</span><br><span class="line">Non-default VM flags: -XX:CICompilerCount=3 -XX:InitialHeapSize=528482304 -XX:+ManagementServer -XX:MaxHeapSize=8434745344 -XX:MaxNewSize=2811232256 -XX:MinHeapDeltaBytes=524288 -XX:NewSize=176160768 -XX:OldSize=352321536 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC</span><br><span class="line">Command line: ...</span><br></pre></td></tr></table></figure><p> 通过jmap查看堆内存</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jmap -heap pid</span></span><br><span class="line">$ jmap -heap 497</span><br><span class="line">Attaching to process ID 497, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.221-b11</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 4 thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 0</span><br><span class="line">   MaxHeapFreeRatio         = 100</span><br><span class="line">   MaxHeapSize              = 8434745344 (8044.0MB)</span><br><span class="line">   NewSize                  = 176160768 (168.0MB)</span><br><span class="line">   MaxNewSize               = 2811232256 (2681.0MB)</span><br><span class="line">   OldSize                  = 352321536 (336.0MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 1774190592 (1692.0MB)</span><br><span class="line">   used     = 156138392 (148.9051742553711MB)</span><br><span class="line">   free     = 1618052200 (1543.094825744629MB)</span><br><span class="line">   8.800542213674415% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 1048576 (1.0MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 1048576 (1.0MB)</span><br><span class="line">   0.0% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 1048576 (1.0MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 1048576 (1.0MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = 606601216 (578.5MB)</span><br><span class="line">   used     = 90496000 (86.3037109375MB)</span><br><span class="line">   free     = 516105216 (492.1962890625MB)</span><br><span class="line">   14.91853257346586% used</span><br><span class="line"></span><br><span class="line">47600 interned Strings occupying 4865784 bytes.</span><br></pre></td></tr></table></figure><p>dump内存，使用jvisualvm分析</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jmap -dump:format=b,file=file.dump pid</span></span><br><span class="line">$ jmap -dump:format=b,file=497.dump 497</span><br></pre></td></tr></table></figure><p>将dump文件导入jvisualvm,在堆中包含的类中，逐步展开至实例。</p><p>堆内存分析 <a href="https://heaphero.io/">https://heaphero.io/</a></p><p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/index.html">https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/index.html</a></p><p>参考：<a href="https://zhuanlan.zhihu.com/p/73727459">https://zhuanlan.zhihu.com/p/73727459</a></p><p>相关：<a href="https://www.v2ex.com/t/669244">https://www.v2ex.com/t/669244</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt; top部分交互命令&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/sp
      
    
    </summary>
    
    
      <category term="工作" scheme="http://yoursite.com/categories/%E5%B7%A5%E4%BD%9C/"/>
    
    
      <category term="java" scheme="http://yoursite.com/tags/java/"/>
    
      <category term="工作" scheme="http://yoursite.com/tags/%E5%B7%A5%E4%BD%9C/"/>
    
      <category term="JVM" scheme="http://yoursite.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>通过URL触发Jenkins构建</title>
    <link href="http://yoursite.com/2020/04/17/Jenkins/%E9%80%9A%E8%BF%87URL%E8%A7%A6%E5%8F%91Jenkins%E6%9E%84%E5%BB%BA/"/>
    <id>http://yoursite.com/2020/04/17/Jenkins/%E9%80%9A%E8%BF%87URL%E8%A7%A6%E5%8F%91Jenkins%E6%9E%84%E5%BB%BA/</id>
    <published>2020-04-16T16:00:00.000Z</published>
    <updated>2020-05-09T02:07:16.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.cnblogs.com/tyrionyang/p/8183819.html">https://www.cnblogs.com/tyrionyang/p/8183819.html</a></p><p>几个插件：<a href="https://www.jianshu.com/p/0457aba7efcf">https://www.jianshu.com/p/0457aba7efcf</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/tyrionyang/p/8183819.html&quot;&gt;https://www.cnblogs.com/tyrionyang/p/8183819.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;几个插件：&lt;a href=&quot;ht
      
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/categories/Jenkins/"/>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>jvisualvm远程监控JVM</title>
    <link href="http://yoursite.com/2020/04/15/%E5%B7%A5%E4%BD%9C/jvisualvm%E8%BF%9C%E7%A8%8B%E7%9B%91%E6%8E%A7JVM/"/>
    <id>http://yoursite.com/2020/04/15/%E5%B7%A5%E4%BD%9C/jvisualvm%E8%BF%9C%E7%A8%8B%E7%9B%91%E6%8E%A7JVM/</id>
    <published>2020-04-14T16:00:00.000Z</published>
    <updated>2020-04-15T10:56:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>jvm进程启动项配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nohup /usr/<span class="built_in">local</span>/java/jdk1.8.0_231/bin/java -Djava.rmi.server.hostname=192.168.1.80 -Dcom.sun.management.jmxremote.port=1100 -Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> -Dcom.sun.management.jmxremote.authenticate=<span class="literal">true</span> -Dcom.sun.management.jmxremote.password.file=/ssdb1/bootserver/jmxremote.passwd -Dcom.sun.management.jmxremote.access.file=/ssdb1/bootserver/jmxremote.access -jar /ssdb1/bootserver/boot8100/cpnspcms/cpnsp-api-1.0.0-SNAPSHOT.jar --server.port=8100 --name=cpnspcms_box &gt; 8100.log 2&gt;&amp;1 &amp;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-Djava.rmi.server.hostname&#x3D;192.168.1.80  # 配置远程服务IP</span><br><span class="line">-Dcom.sun.management.jmxremote.port&#x3D;1100 # 配置远程 connection 的端口号</span><br><span class="line">-Dcom.sun.management.jmxremote.ssl&#x3D;false # 是否启用 ssl</span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate&#x3D;true  # 是否启用鉴权（需要用户名，密码鉴权）</span><br><span class="line">-Dcom.sun.management.jmxremote.password.file&#x3D;&#x2F;ssdb1&#x2F;bootserver&#x2F;jmxremote.passwd </span><br><span class="line">-Dcom.sun.management.jmxremote.access.file&#x3D;&#x2F;ssdb1&#x2F;bootserver&#x2F;jmxremote.access</span><br></pre></td></tr></table></figure><p>如果authenticate=false的时候不需要配置jmxremote.passwd 和jmxremote.access</p><p>否则需要在jmxremote.access中指定用户名和读写权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">monitorRole readonly</span><br><span class="line">controlRole readwrite</span><br></pre></td></tr></table></figure><p>jmxremote.passwd中指定用户名和密码，格式如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">monitorRole tomcat</span><br><span class="line">controlRole tomcat</span><br></pre></td></tr></table></figure><p>设置文件权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> chmod 400 jmxremote.access</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chmod 400 jmxremote.passwd</span></span><br></pre></td></tr></table></figure><p>然后在jvisualvm添加JMX连接。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;jvm进程启动项配置&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;co
      
    
    </summary>
    
    
      <category term="工作" scheme="http://yoursite.com/categories/%E5%B7%A5%E4%BD%9C/"/>
    
    
      <category term="java" scheme="http://yoursite.com/tags/java/"/>
    
      <category term="工作" scheme="http://yoursite.com/tags/%E5%B7%A5%E4%BD%9C/"/>
    
  </entry>
  
  <entry>
    <title>nginx配置文件中if多重判断</title>
    <link href="http://yoursite.com/2020/03/29/nginx/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/nginx%E4%B8%ADif%E5%8F%8C%E9%87%8D%E5%88%A4%E6%96%AD/"/>
    <id>http://yoursite.com/2020/03/29/nginx/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/nginx%E4%B8%ADif%E5%8F%8C%E9%87%8D%E5%88%A4%E6%96%AD/</id>
    <published>2020-03-28T16:00:00.000Z</published>
    <updated>2020-03-29T01:03:48.000Z</updated>
    
    <content type="html"><![CDATA[<p>nginx配置文件中if多重判断</p><p>Nginx不支持 and、or、&amp;&amp;、|| 这类语法；且不支持if的多重嵌套。</p><h5 id="实现方法一"><a href="#实现方法一" class="headerlink" title="实现方法一"></a>实现方法一</h5><p>每个域名配置单独的server{}，这样配置比较简明；但缺点是配置文件会写很长，要修改多次。（比较啰嗦）。</p><h5 id="实现方法二"><a href="#实现方法二" class="headerlink" title="实现方法二"></a>实现方法二</h5><p>全部域名配置一个server{}，进行多重判断；这样配置可能稍微复杂一点，但配置文件不会那么啰嗦。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> xzjps.bjcscn.com hncszj.bjupi.com;</span><br><span class="line">    <span class="attribute">root</span>   html/unitrecordO_zjps;</span><br><span class="line">    <span class="attribute">index</span>    index.html;</span><br><span class="line"></span><br><span class="line">   <span class="attribute">location</span> = /&#123;</span><br><span class="line">               <span class="attribute">set</span> <span class="variable">$flag</span> <span class="number">0</span>;</span><br><span class="line">               <span class="attribute">if</span> (<span class="variable">$host</span> = <span class="string">"hncszj.bjupi.com"</span>)&#123;</span><br><span class="line">                    <span class="attribute">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>1"</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="attribute">if</span> (<span class="variable">$query_string</span> !<span class="regexp">~*  ^(.*)userGroup=(.*)$)</span>&#123;</span><br><span class="line">                   <span class="attribute">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>2"</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="attribute">if</span> (<span class="variable">$flag</span> <span class="regexp">~* "012")</span>&#123;</span><br><span class="line">                    <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span>  http://hncszj.bjupi.com/?userGroup=41 <span class="literal">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果满足条件一并同时也满足条件二,就重定向到http://hncszj.bjupi.com/?userGroup=41</span></span><br><span class="line">    </span><br><span class="line">  <span class="attribute">location</span> = /index.html &#123;</span><br><span class="line">               <span class="attribute">add_header</span> Cache-Control <span class="string">"no-cache no-store"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">   <span class="attribute">location</span> /&#123;</span><br><span class="line">       <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="attribute">location</span> /cpnsp/&#123;</span><br><span class="line">      <span class="attribute">proxy_connect_timeout</span>   <span class="number">3</span>;</span><br><span class="line">       <span class="attribute">proxy_send_timeout</span>      <span class="number">300</span>;</span><br><span class="line">      <span class="attribute">proxy_read_timeout</span>      <span class="number">300</span>;</span><br><span class="line">      <span class="attribute">proxy_pass</span>    http://urstrem3;</span><br><span class="line">      <span class="attribute">proxy_set_header</span>   REMOTE_ADDR  <span class="variable">$remote_addr</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span>  Host  <span class="variable">$host</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">       <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">      <span class="attribute">root</span>    html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;nginx配置文件中if多重判断&lt;/p&gt;
&lt;p&gt;Nginx不支持 and、or、&amp;amp;&amp;amp;、|| 这类语法；且不支持if的多重嵌套。&lt;/p&gt;
&lt;h5 id=&quot;实现方法一&quot;&gt;&lt;a href=&quot;#实现方法一&quot; class=&quot;headerlink&quot; title=&quot;实现方
      
    
    </summary>
    
    
      <category term="nginx" scheme="http://yoursite.com/categories/nginx/"/>
    
    
      <category term="nginx" scheme="http://yoursite.com/tags/nginx/"/>
    
      <category term="nginx配置" scheme="http://yoursite.com/tags/nginx%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>nginx配置文件中if多重判断</title>
    <link href="http://yoursite.com/2020/03/29/nginx/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/nginx%E4%B8%ADmax_fails%E5%92%8Cfail_timeout/"/>
    <id>http://yoursite.com/2020/03/29/nginx/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/nginx%E4%B8%ADmax_fails%E5%92%8Cfail_timeout/</id>
    <published>2020-03-28T16:00:00.000Z</published>
    <updated>2020-05-28T11:18:07.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> teststrem2 &#123;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">127.0.0.1:8300</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">60s</span>;</span><br><span class="line">      <span class="attribute">server</span> <span class="number">127.0.0.1:8301</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">60s</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>max_fails 、 fail_timeout 是Nginx的负载均衡检查模块中两个可选参数。用于判断后端节点状态。</p><p>Nginx基于连接探测，如果发现后端异常，在单位周期为fail_timeout设置的时间，中达到max_fails次数，这个周期次数内，如果后端同一个节点不可用，那么将把节点标记为不可用，并等待下一个周期（同样时常为fail_timeout）再一次去请求，判断是否连接是否成功。如果成功，将恢复之前的轮询方式，如果不可用将在下一个周期(fail_timeout)再试一次。</p><p>在两个节点都可用的情况下，突然有一个节点挂掉，客户端请求过来后哪怕请求到了不可用的节点，此次请求也不会失败，因为Nginx会把此次请求转发到另外一个可用节点，再把结果返回给客户端。<br>当一个节点挂掉，Nginx不知道节点是否恢复的时候，会把客户端的请求同时转发到两个节点，判断节点健康情况。</p><p>可用于解决之前刘问的问题，后端服务更新或者出现溢出，服务不可用时，导致前端桌面端卡死的情况。</p><p>参考：<a href="https://blog.51cto.com/kexiaoke/2316851">https://blog.51cto.com/kexiaoke/2316851</a></p><p>参考：<a href="https://blog.51cto.com/kexiaoke/2316851">https://blog.51cto.com/kexiaoke/2316851</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight nginx&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
      <category term="nginx" scheme="http://yoursite.com/categories/nginx/"/>
    
    
      <category term="nginx" scheme="http://yoursite.com/tags/nginx/"/>
    
      <category term="nginx配置" scheme="http://yoursite.com/tags/nginx%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>慢查询优化1</title>
    <link href="http://yoursite.com/2020/03/27/%E6%95%B0%E6%8D%AE%E5%BA%93/mongodb/%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%961/"/>
    <id>http://yoursite.com/2020/03/27/%E6%95%B0%E6%8D%AE%E5%BA%93/mongodb/%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%961/</id>
    <published>2020-03-26T16:00:00.000Z</published>
    <updated>2020-03-27T12:45:35.000Z</updated>
    
    <content type="html"><![CDATA[<p> 慢查询优化</p><p>在阿里云mongodb控制台，可看到慢日志的统计和明细分析比较方便，或者可以在mongodb shll环境中针对某个数据库查看慢日志记录。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.system.profile.find( &#123; millis : &#123; $gt : 120 &#125; &#125; )</span><br></pre></td></tr></table></figure><p>在控制台查得如下慢查询记录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.setStudyRecord.find(&#123;"ownerId": "eat_cp_210",</span><br><span class="line">            "courseId": 488,</span><br><span class="line">            "studentId": 7107,</span><br><span class="line">            "studyType": &#123;</span><br><span class="line">                "$gte": 10,</span><br><span class="line">                "$lt": 20</span><br><span class="line">            &#125;,</span><br><span class="line">            "isFinished": false,</span><br><span class="line">            "studyResId": &#123;</span><br><span class="line">                "$in": [  1344,1345,1347,1348,1349,1350,1351  ]</span><br><span class="line">                &#125;&#125;)</span><br></pre></td></tr></table></figure><p>使用MongoDB explain进行分析</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line">db.setStudyRecord.find(&#123;"ownerId": "eat_cp_210",</span><br><span class="line">            "courseId": 488,</span><br><span class="line">            "studentId": 7107,</span><br><span class="line">            "studyType": &#123;</span><br><span class="line">                "$gte": 10,</span><br><span class="line">                "$lt": 20</span><br><span class="line">            &#125;,</span><br><span class="line">            "isFinished": false,</span><br><span class="line">            "studyResId": &#123;</span><br><span class="line">                "$in": [1344,1345,1347,1348,1349,1350,1351 ]</span><br><span class="line"> &#125;&#125;).explain("executionStats");</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"queryPlanner"</span> : &#123;</span><br><span class="line">        <span class="attr">"plannerVersion"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"namespace"</span> : <span class="string">"aixueyou_eat190428.setStudyRecord"</span>,</span><br><span class="line">        <span class="attr">"indexFilterSet"</span> : <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"parsedQuery"</span> : &#123;</span><br><span class="line">            <span class="attr">"$and"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"courseId"</span> : &#123;</span><br><span class="line">                        <span class="attr">"$eq"</span> : <span class="number">488</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"isFinished"</span> : &#123;</span><br><span class="line">                        <span class="attr">"$eq"</span> : <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"ownerId"</span> : &#123;</span><br><span class="line">                        <span class="attr">"$eq"</span> : <span class="string">"eat_cp_210"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"studentId"</span> : &#123;</span><br><span class="line">                        <span class="attr">"$eq"</span> : <span class="number">7107</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"studyType"</span> : &#123;</span><br><span class="line">                        <span class="attr">"$lt"</span> : <span class="number">20</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"studyType"</span> : &#123;</span><br><span class="line">                        <span class="attr">"$gte"</span> : <span class="number">10</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"studyResId"</span> : &#123;</span><br><span class="line">                        <span class="attr">"$in"</span> : [</span><br><span class="line">                            <span class="number">1344</span>,</span><br><span class="line">                            <span class="number">1345</span>,</span><br><span class="line">                            <span class="number">1347</span>,</span><br><span class="line">                            <span class="number">1348</span>,</span><br><span class="line">                            <span class="number">1349</span>,</span><br><span class="line">                            <span class="number">1350</span>,</span><br><span class="line">                            <span class="number">1351</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"winningPlan"</span> : &#123;</span><br><span class="line">            <span class="attr">"stage"</span> : <span class="string">"COLLSCAN"</span>,</span><br><span class="line">            <span class="attr">"filter"</span> : &#123;</span><br><span class="line">                <span class="attr">"$and"</span> : [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"courseId"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$eq"</span> : <span class="number">488</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"isFinished"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$eq"</span> : <span class="literal">false</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"ownerId"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$eq"</span> : <span class="string">"eat_cp_210"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"studentId"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$eq"</span> : <span class="number">7107</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"studyType"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$lt"</span> : <span class="number">20</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"studyType"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$gte"</span> : <span class="number">10</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"studyResId"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$in"</span> : [</span><br><span class="line">                                <span class="number">1344</span>,</span><br><span class="line">                                <span class="number">1345</span>,</span><br><span class="line">                                <span class="number">1347</span>,</span><br><span class="line">                                <span class="number">1348</span>,</span><br><span class="line">                                <span class="number">1349</span>,</span><br><span class="line">                                <span class="number">1350</span>,</span><br><span class="line">                                <span class="number">1351</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"direction"</span> : <span class="string">"forward"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"rejectedPlans"</span> : [ ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"executionStats"</span> : &#123;</span><br><span class="line">        <span class="attr">"executionSuccess"</span> : <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"nReturned"</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"executionTimeMillis"</span> : <span class="number">289</span>,</span><br><span class="line">        <span class="attr">"totalKeysExamined"</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"totalDocsExamined"</span> : <span class="number">286856</span>,</span><br><span class="line">        <span class="attr">"executionStages"</span> : &#123;</span><br><span class="line">            <span class="attr">"stage"</span> : <span class="string">"COLLSCAN"</span>,</span><br><span class="line">            <span class="attr">"filter"</span> : &#123;</span><br><span class="line">                <span class="attr">"$and"</span> : [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"courseId"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$eq"</span> : <span class="number">488</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"isFinished"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$eq"</span> : <span class="literal">false</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"ownerId"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$eq"</span> : <span class="string">"eat_cp_210"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"studentId"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$eq"</span> : <span class="number">7107</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"studyType"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$lt"</span> : <span class="number">20</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"studyType"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$gte"</span> : <span class="number">10</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"studyResId"</span> : &#123;</span><br><span class="line">                            <span class="attr">"$in"</span> : [</span><br><span class="line">                                <span class="number">1344</span>,</span><br><span class="line">                                <span class="number">1345</span>,</span><br><span class="line">                                <span class="number">1347</span>,</span><br><span class="line">                                <span class="number">1348</span>,</span><br><span class="line">                                <span class="number">1349</span>,</span><br><span class="line">                                <span class="number">1350</span>,</span><br><span class="line">                                <span class="number">1351</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"nReturned"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"executionTimeMillisEstimate"</span> : <span class="number">280</span>,</span><br><span class="line">            <span class="attr">"works"</span> : <span class="number">286858</span>,</span><br><span class="line">            <span class="attr">"advanced"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"needTime"</span> : <span class="number">286857</span>,</span><br><span class="line">            <span class="attr">"needYield"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"saveState"</span> : <span class="number">2241</span>,</span><br><span class="line">            <span class="attr">"restoreState"</span> : <span class="number">2241</span>,</span><br><span class="line">            <span class="attr">"isEOF"</span> : <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"invalidates"</span> : <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"direction"</span> : <span class="string">"forward"</span>,</span><br><span class="line">            <span class="attr">"docsExamined"</span> : <span class="number">286856</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"ok"</span> : <span class="number">1</span>,</span><br><span class="line">    "operationTime" : Timestamp(1585311418, 2),</span><br><span class="line">    "$clusterTime" : &#123;</span><br><span class="line">        "clusterTime" : Timestamp(1585311418, 2),</span><br><span class="line">        "signature" : &#123;</span><br><span class="line">            "hash" : BinData(0,"vFOb4kXYvePgnFtOu1B8ASuxLi0="),</span><br><span class="line">            "keyId" : NumberLong("6778070851129442306")</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到是全表扫描，执行时间280ms</p><p>建立索引</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> db.setStudyRecord.createIndex( &#123; ownerId: 1,courseId:1,studentId:1,studyType:1,isFinished:1,studyResId:1&#125;, &#123;background: <span class="literal">true</span>&#125; )</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt; 慢查询优化&lt;/p&gt;
&lt;p&gt;在阿里云mongodb控制台，可看到慢日志的统计和明细分析比较方便，或者可以在mongodb shll环境中针对某个数据库查看慢日志记录。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td cl
      
    
    </summary>
    
    
      <category term="MongoDB" scheme="http://yoursite.com/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="http://yoursite.com/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>mongodb按字符串长度查找数据</title>
    <link href="http://yoursite.com/2020/03/16/%E6%95%B0%E6%8D%AE%E5%BA%93/mongodb/%E6%8C%89%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%95%BF%E5%BA%A6%E6%9F%A5%E6%89%BE%E6%95%B0%E6%8D%AE/"/>
    <id>http://yoursite.com/2020/03/16/%E6%95%B0%E6%8D%AE%E5%BA%93/mongodb/%E6%8C%89%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%95%BF%E5%BA%A6%E6%9F%A5%E6%89%BE%E6%95%B0%E6%8D%AE/</id>
    <published>2020-03-15T16:00:00.000Z</published>
    <updated>2020-03-17T02:56:13.569Z</updated>
    
    <content type="html"><![CDATA[<p>根据字符串字段的长度来筛选一些数据，这时候可能会用到正则表达式，也可以用mongodb的$where。</p><p>查询职业编码大于等于10的职业。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="variable">$where</span>写法:</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> db.spOccupation.find(&#123;<span class="string">"<span class="variable">$where</span>"</span>:<span class="string">"this.code.length&gt;=10"</span>&#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 正则表达式写法：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> db.spOccupation.find(&#123;<span class="string">"code"</span>:&#123;<span class="string">"<span class="variable">$regex</span>"</span>:/^.&#123;10,&#125;$/&#125;&#125;);</span></span><br></pre></td></tr></table></figure><p>其他条件正则：<br><strong>^.{n,m}$</strong>        n &lt;= 长度 &lt;= m<br><strong>^.{n}$</strong>            长度 = n</p><p>这个长度是字符的长度，比如”正则表达式”长度就是5</p><p>正则的性能比$where 的速度快很多 </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;根据字符串字段的长度来筛选一些数据，这时候可能会用到正则表达式，也可以用mongodb的$where。&lt;/p&gt;
&lt;p&gt;查询职业编码大于等于10的职业。&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut
      
    
    </summary>
    
    
      <category term="mongodb" scheme="http://yoursite.com/categories/mongodb/"/>
    
    
      <category term="mongodb" scheme="http://yoursite.com/tags/mongodb/"/>
    
      <category term="数据操作" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C/"/>
    
  </entry>
  
  <entry>
    <title>两路由局域网服务访问</title>
    <link href="http://yoursite.com/2020/01/02/%E5%B7%A5%E4%BD%9C/%E4%B8%A4%E8%B7%AF%E7%94%B1%E5%B1%80%E5%9F%9F%E7%BD%91%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE/"/>
    <id>http://yoursite.com/2020/01/02/%E5%B7%A5%E4%BD%9C/%E4%B8%A4%E8%B7%AF%E7%94%B1%E5%B1%80%E5%9F%9F%E7%BD%91%E6%9C%8D%E5%8A%A1%E8%AE%BF%E9%97%AE/</id>
    <published>2020-01-01T16:00:00.000Z</published>
    <updated>2020-06-04T03:20:47.349Z</updated>
    
    <content type="html"><![CDATA[<p>两路由组建局域网，实现服务访问</p><h4 id="需求：在不修改和影响原有网络及盒子IP的情况下，通过pc访问盒子上的服务。"><a href="#需求：在不修改和影响原有网络及盒子IP的情况下，通过pc访问盒子上的服务。" class="headerlink" title="需求：在不修改和影响原有网络及盒子IP的情况下，通过pc访问盒子上的服务。"></a>需求：在不修改和影响原有网络及盒子IP的情况下，通过pc访问盒子上的服务。</h4><p><a href="https://simimg.com/i/5HSuX"><img src="https://s1.simimg.com/2017/09/03/5HSuX.png" alt="5HSuX.png"></a></p><h1 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h1><p>  1、原有网络局域网现状<br>       主路由：网关：192.168.1.2<br>              子网掩码：255.255.255.0<br>              IP:192.168.1.xxx<br>        PC :  IP：192.168.1.101<br>             子网掩码：255.255.255.0<br>             网关：192.168.1.2<br>  2、副路由<br>      LAN口： IP:10.10.10.1<br>             子网掩码：255.0.0.0<br>      WAN口： IP:192.168.1.20<br>              子网掩码：255.255.255.0<br>              网关：192.168.1.2<br>  3、盒子<br>      IP:10.10.10.100<br>      子网掩码：255.0.0.0<br>      网关：10.10.10.1</p><h1 id="副路由-（TP-LINK）设置"><a href="#副路由-（TP-LINK）设置" class="headerlink" title="副路由 （TP-LINK）设置"></a>副路由 （TP-LINK）设置</h1><p>   1、路由通电后，通过浏览器访问路由地址（192.168.0.1）。<br>   2、LAN口设置：IP地址：10.10.10.1（可任意），子网掩码：255.0.0.0（根据IP定）。<br>   3、保存，重启路由。<br>   4、通过浏览器访问路由地址10.10.10.1<br>   5、WAN口设置<br>         模式：静态IP<br>         IP地址：192.168.1.20（在原局域网内不冲突即可，此IP用于盒子服务的访问）<br>         子网掩码：255.255.255.0<br>         网关：192.168.1.2<br>         DNS服务器：192.168.1.2<br>   6、虚拟服务器 端口映射 把80端口映射到盒子ip:10.10.10.100<br>   7、把网线从原路由LAN口连接到副路由WAN口。</p><h1 id="盒子服务安装及设置"><a href="#盒子服务安装及设置" class="headerlink" title="盒子服务安装及设置"></a>盒子服务安装及设置</h1><p>   1、安装好Tomcat及nginx服务。(注意：静态页面中IP要为动态获取。)<br>   2、修改nginx配置：监听80端口，转发到tomcat。<br>即可在PC上通过192.168.1.20访问盒子上的tomcat服务。</p><h1 id="下面实现可以域名访问"><a href="#下面实现可以域名访问" class="headerlink" title="下面实现可以域名访问"></a>下面实现可以域名访问</h1><p>前提：拥有主路由的管理权（要修改DNS）<br>   因要考虑在无网络的情况及不修改原有网络机器，所以在盒子上部署DNS服务器。<br>   1、在盒子上部署DNS服务器。（参考上篇：DNS主备服务）<br>   2、配置域名指向,域名指向的IP地址应为副路由WAN口地址（192.168.1.20）<br>   3、在副路由中配置DNS<br>      在虚拟服务器 端口映射添加记录，把53端口指向到盒子IP:10.10.10.100,协议为全部。<br>   4、在主路由中配置DNS<br>      在DHCP服务器中首选DNS输入192.168.1.20，备用DNS输入114.114.114.114<br>即可在PC上通过域名访问盒子上服务。</p><h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><p>如若在准备阶段就可给盒子分配一该网络下固定的IP，就可省去路由这一步。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;两路由组建局域网，实现服务访问&lt;/p&gt;
&lt;h4 id=&quot;需求：在不修改和影响原有网络及盒子IP的情况下，通过pc访问盒子上的服务。&quot;&gt;&lt;a href=&quot;#需求：在不修改和影响原有网络及盒子IP的情况下，通过pc访问盒子上的服务。&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
      <category term="工作" scheme="http://yoursite.com/categories/%E5%B7%A5%E4%BD%9C/"/>
    
    
      <category term="工作" scheme="http://yoursite.com/tags/%E5%B7%A5%E4%BD%9C/"/>
    
  </entry>
  
  <entry>
    <title>将Jenkins安装为systemd服务</title>
    <link href="http://yoursite.com/2019/12/28/Jenkins/%E5%B0%86jenkins%E5%AE%89%E8%A3%85%E4%B8%BAsystemd%E6%9C%8D%E5%8A%A1/"/>
    <id>http://yoursite.com/2019/12/28/Jenkins/%E5%B0%86jenkins%E5%AE%89%E8%A3%85%E4%B8%BAsystemd%E6%9C%8D%E5%8A%A1/</id>
    <published>2019-12-27T16:00:00.000Z</published>
    <updated>2019-12-28T09:56:50.157Z</updated>
    
    <content type="html"><![CDATA[<p>Jenkins的部署方式是将jar放在了tomcat下(具体参考之前的部署方式)，然后通过系统环境变量(<code>/etc/profile</code>)中指定Jenkins工作空间及时区变量。</p><p>所以此文将Jenkins安装为systemd服务，也就是将tomcat安装为systemd服务。</p><p>1、新建项目的systemd管理文件jenkins.service</p><p><code>vim /etc/systemd/system/jenkins.service</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=jenkins-tomcat9900</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">WorkingDirectory=/ssdb1/tomcat/tomcat-jenkins/bin</span><br><span class="line">Environment=JAVA_HOME==/usr/<span class="built_in">local</span>/java/jdk1.8.0_231</span><br><span class="line">Environment=JENKINS_HOME=/ssdb1/jenkins</span><br><span class="line">Environment=JENKINS_JAVA_OPTIONS=<span class="string">"-Dorg.apache.commons.jelly.tags.fmt.timeZone=Asia/Shanghai"</span></span><br><span class="line">ExecStart=/ssdb1/tomcat/tomcat-jenkins/bin/catalina.sh start</span><br><span class="line">ExecReload=/ssdb1/tomcat/tomcat-jenkins/bin/catalina.sh restart</span><br><span class="line">ExecStop=/ssdb1/tomcat/tomcat-jenkins/bin/catalina.sh stop</span><br><span class="line">SuccessExitStatus=143</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>主要注意点，通过systemd进行管理的服务，在<code>/etc/profile</code>中定义的环境变量，不会生效，所以需要通过<code>Environment</code> 定义环境变量。</p><p>2、管理</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> jenkins.service</span><br><span class="line">$ systemctl start jenkins.service</span><br></pre></td></tr></table></figure><p>3、查看状态</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status jenkins.service</span><br></pre></td></tr></table></figure><p>4、查看服务日志</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$  vim /var/<span class="built_in">log</span>/syslog</span><br></pre></td></tr></table></figure><p>之前的相关记录：<br><a href="https://myqzf.github.io/2018/08/29/java/Spring-Boot/Spring-boot%E9%83%A8%E7%BD%B2/">https://myqzf.github.io/2018/08/29/java/Spring-Boot/Spring-boot%E9%83%A8%E7%BD%B2/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Jenkins的部署方式是将jar放在了tomcat下(具体参考之前的部署方式)，然后通过系统环境变量(&lt;code&gt;/etc/profile&lt;/code&gt;)中指定Jenkins工作空间及时区变量。&lt;/p&gt;
&lt;p&gt;所以此文将Jenkins安装为systemd服务，也就是将to
      
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/categories/Jenkins/"/>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
      <category term="systemd" scheme="http://yoursite.com/tags/systemd/"/>
    
      <category term="tomcat" scheme="http://yoursite.com/tags/tomcat/"/>
    
  </entry>
  
  <entry>
    <title>jasperreports报表导出</title>
    <link href="http://yoursite.com/2019/12/28/java/jasperreports%E6%8A%A5%E8%A1%A8%E5%AD%97%E4%BD%93%E5%8A%A0%E8%BD%BD%E9%97%AE%E9%A2%98/"/>
    <id>http://yoursite.com/2019/12/28/java/jasperreports%E6%8A%A5%E8%A1%A8%E5%AD%97%E4%BD%93%E5%8A%A0%E8%BD%BD%E9%97%AE%E9%A2%98/</id>
    <published>2019-12-27T16:00:00.000Z</published>
    <updated>2020-04-09T00:53:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>今天通知线上服务jasperreports报表pdf显示有问题，报错信息如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.sf.jasperreports.engine.util.JRFontNotFoundException: Font &#39;宋体&#39; is not available to the JVM. See the Javadoc for more details.</span><br></pre></td></tr></table></figure><p>本地是正常的，搜了下说和Linux字体有关。</p><p>拷贝windows下的字体到Ubuntu系统中，把字体放在项目class path下，都尝试了，没能解决问题。</p><p>下面是解决的过程</p><p>把windows下的需要的字体(C:\Windows\Fonts)到Ubuntu目录<code>/usr/share/fonts/TTF</code>(不存在则新建)下。</p><p>然后执行如下命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update</span><br><span class="line">$ apt install xfonts-utils</span><br><span class="line">$ mkfontdir</span><br><span class="line">$ <span class="built_in">fc</span>-cache -fv</span><br></pre></td></tr></table></figure><p>最后重启服务，便正常显示了。</p><p>参考：<a href="https://blog.csdn.net/qq_26365837/article/details/91954206">Ubuntu系统安装字体方法</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;今天通知线上服务jasperreports报表pdf显示有问题，报错信息如下&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;
      
    
    </summary>
    
    
      <category term="Java" scheme="http://yoursite.com/categories/Java/"/>
    
    
      <category term="jasperreports" scheme="http://yoursite.com/tags/jasperreports/"/>
    
      <category term="pdf" scheme="http://yoursite.com/tags/pdf/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins应用--上传文件至七牛</title>
    <link href="http://yoursite.com/2019/12/27/Jenkins/jenkins%E5%BA%94%E7%94%A8--%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E8%87%B3%E4%B8%83%E7%89%9B/"/>
    <id>http://yoursite.com/2019/12/27/Jenkins/jenkins%E5%BA%94%E7%94%A8--%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E8%87%B3%E4%B8%83%E7%89%9B/</id>
    <published>2019-12-26T16:00:00.000Z</published>
    <updated>2019-12-27T07:51:43.000Z</updated>
    
    <content type="html"><![CDATA[<p>上传前端文件至七牛</p><p>在Ubuntu服务器上搭建了Samba服务。</p><p>更新前端文件时，只要把压缩包上传至共享文件夹的指定目录，然后通过jenkins进行构建时，会解压前端的压缩包，然后把解压后的文件拷贝到jenkins工作空间，然后通过七牛上传插件上传到七牛空间，并把index文件上传到服务器nginx文件夹下。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">QINIUPREFIX=jndjrd  #七牛前缀</span><br><span class="line">FILE_DIR=/ssdb2/share/front/qiniu/jndjrd</span><br><span class="line">UNPACK_DIR=$FILE_DIR/unpack   #解压输出目录</span><br><span class="line">PROJECT_DIR=$WORKSPACE/$QINIUPREFIX  #上传文件目录</span><br><span class="line"></span><br><span class="line">cd $FILE_DIR</span><br><span class="line">zipCnt=`ls -l |grep "^-"|wc -l`</span><br><span class="line">echo "zipCnt=$zipCnt"</span><br><span class="line"></span><br><span class="line">if [ "$zipCnt" -eq "1" ];then</span><br><span class="line">   cp $FILE_DIR/* /ssdb2/share/front/backup/    #备份</span><br><span class="line">   zipName=`find *.zip`</span><br><span class="line">   echo "zipName=$zipName"</span><br><span class="line">   unzip $zipName -d $UNPACK_DIR</span><br><span class="line">else</span><br><span class="line">   echo "压缩文件存在 $zipCnt 个，构建退出"</span><br><span class="line">   set -e #注意，一定要先设置这个</span><br><span class="line">   exit 1  #然后再退出，jenkins就会报红显示构建失败</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo $WORKSPACE</span><br><span class="line">rm -r $PROJECT_DIR/</span><br><span class="line">mkdir $PROJECT_DIR</span><br><span class="line">cd $UNPACK_DIR/*/</span><br><span class="line">cp -r ./ $PROJECT_DIR</span><br><span class="line">rm -r $FILE_DIR/*     #清空目录，注意：删除高危操作！！！！</span><br></pre></td></tr></table></figure><p>脚本实现的主要是判断上传要更新的文件夹的前端压缩包个数，如果压缩包个数为1，则 拷贝压缩包至备份目录下，然后解压压缩包到unpack文件夹下，然后清空jenkins工作空间上次构建的文件，接着把解压后的文件拷贝到工作空间，等待着通过jenkins插件进行上传。然后清空上传的目录，以便下次更新上传压缩包。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上传前端文件至七牛&lt;/p&gt;
&lt;p&gt;在Ubuntu服务器上搭建了Samba服务。&lt;/p&gt;
&lt;p&gt;更新前端文件时，只要把压缩包上传至共享文件夹的指定目录，然后通过jenkins进行构建时，会解压前端的压缩包，然后把解压后的文件拷贝到jenkins工作空间，然后通过七牛上传插件上
      
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/categories/Jenkins/"/>
    
    
      <category term="Jenkins" scheme="http://yoursite.com/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>GitHub提交时忽略不必要上传的文件</title>
    <link href="http://yoursite.com/2019/12/21/%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/git/GitHub%E6%8F%90%E4%BA%A4%E6%97%B6%E5%BF%BD%E7%95%A5%E4%B8%8D%E5%BF%85%E8%A6%81%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6/"/>
    <id>http://yoursite.com/2019/12/21/%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/git/GitHub%E6%8F%90%E4%BA%A4%E6%97%B6%E5%BF%BD%E7%95%A5%E4%B8%8D%E5%BF%85%E8%A6%81%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6/</id>
    <published>2019-12-20T16:00:00.000Z</published>
    <updated>2019-12-21T12:54:28.399Z</updated>
    
    <content type="html"><![CDATA[<p>新建.gitignore文件，写入要忽略的内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.gitignore  </span><br><span class="line">.settings&#x2F;  &#x2F;&#x2F;忽略idea目录下的所有文件</span><br><span class="line">.project  &#x2F;&#x2F;忽略项目根目录下的 .project 文件</span><br><span class="line">target&#x2F;</span><br><span class="line"></span><br><span class="line">*.zip            &#x2F;&#x2F;忽略所有.zip结尾的文件</span><br><span class="line">doc&#x2F;*.txt        &#x2F;&#x2F;忽略 doc&#x2F;notes.txt,但不包括 doc&#x2F;server&#x2F;arch.txt</span><br><span class="line"></span><br><span class="line">!test.txt        &#x2F;&#x2F;不忽略 test.txt 文件</span><br></pre></td></tr></table></figure><p>注:如果要忽略的文件已被git管理,需要先移除,命令如下:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rm -r  target/    //-r为递归</span><br></pre></td></tr></table></figure><p> 然后git commit</p><p> 最后.gitignore中的忽略，就会起作用</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;新建.gitignore文件，写入要忽略的内容&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class
      
    
    </summary>
    
    
      <category term="git" scheme="http://yoursite.com/categories/git/"/>
    
    
      <category term="git" scheme="http://yoursite.com/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>Jmeter压测</title>
    <link href="http://yoursite.com/2019/12/16/%E5%B7%A5%E4%BD%9C/Jmeter%E5%8E%8B%E6%B5%8B-DESKTOP-S52MH0E/"/>
    <id>http://yoursite.com/2019/12/16/%E5%B7%A5%E4%BD%9C/Jmeter%E5%8E%8B%E6%B5%8B-DESKTOP-S52MH0E/</id>
    <published>2019-12-15T16:00:00.000Z</published>
    <updated>2019-12-29T14:26:10.278Z</updated>
    
    <content type="html"><![CDATA[<p> 首先使用chrome插件BlazeMeter，录制jmeter请求脚本，导入到jmeter中。</p><p>对需要引用大量的外部数据，如用户名密码，可以添加   配置原件–&gt;CSV 数据文件设置变量，在请求中进行引用。</p><p>对需要引用获取到的请求数据，可以在所需请求后添加  后置处理器–&gt;正则表达式提取器,对变量值进行提取，然后再后续请求中引用。</p><p>使用集合点，阻塞线程，直到指定的线程数量到达后，再一起释放，可以瞬间产生很大的压力。（添加–&gt;定时器–&gt;同步定时器）（可能会导致部分线程组一直不结束）</p><p>压测</p><p>开启5000个线程组时，大量请求报错 java.net.BindException: Address already in use: connect</p><p>原因：可能是由TCP / IP端口耗尽引起的。在非常高的负载下，反复连接到其他服务的服务器可能会耗尽临时端口。 刚刚关闭的端口号在重新使用之前，会保持一段时间的等待状态。如果连接速率足够高，则所有端口最终都将处于等待状态，并且操作系统将无法再将连接绑定到端口。 </p><p>排查：可以使用以下内容确定端口耗尽是否是真正的瓶颈 。</p><p>1、在峰值负载下，运行“ netstat -ano -p tcp”将列出所有正在使用的端口。 </p><p>2、使用“ netsh int ipv4 show dynamicport tcp”监视范围内的可用端口。 </p><p>确定了如是导致的原因，解决</p><p>1、增加动态端口范围，默认情况下，最大值为5000，最多可以将其设置为65534，</p><p>HKLM\System\CurrentControlSet\Services\Tcpip\Parameters\MaxUserPort 。</p><p>2、减少TIME_WAIT 状态 的时间 ，默认为4分钟，可以将其设置为30秒 ，</p><p>HKLM\System\CurrentControlSet\Services\Tcpip\Parameters\TCPTimedWaitDelay 。</p><p>参考：<a href="https://support.pitneybowes.com/VFP06_KnowledgeWithSidebarTroubleshoot?id=kA280000000CgbbCAC&popup=false&lang=en_US">Address already in use: connect” in EngageOne Vault </a></p><p>  接下来测试</p><p>后台服务中报 org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe。 </p><p>主要原因是 客户端先关闭了连接，服务器端没有执行关闭连接的操作。 </p><p>压测时在服务器执行</p><p>netstat -n | awk ‘/^tcp/ {++state[$NF]} END {for(key in state) print key,”\t”,state[key]}’</p><p>查看了下当时tcpip连接的状态，进一步排查。</p><p>这个原因是因为jmeter线程组一直不结束，在jmeter中手动停止了所有线程导致。</p><p>在jmeter请求中也会出现这样的错误java net SocketException: Socket closed</p><p>参考:[java.io.IOException: Broken pipe](<a href="https://blog.csdn.net/zqz_zqz/article/details/52235479">https://blog.csdn.net/zqz_zqz/article/details/52235479</a> N )</p><p>接着测试</p><p>使用nginx进行负载均衡到两个后台服务时，nginx日志发现<code>socket() failed (24: Too many open files) while connecting to upstream</code> </p><p>修改linux打开文件句柄数(可能遇到修改后不生效问题) 参考:<a href="<https://blog.csdn.net/leshami/article/details/8749773">ulimit: open files: cannot modify limit</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/security/limits.conf</span><br><span class="line">root  soft  nproc 16384</span><br><span class="line">root  hard  nproc 16384</span><br><span class="line">root  soft  nofile 65535</span><br><span class="line">root  hard  nofile 65535</span><br><span class="line">root  soft  memlock  4000000</span><br><span class="line">root  hard  memlock  4000000</span><br><span class="line">$ shutdown –r now  <span class="comment">#重启服务器</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -a  <span class="comment">#检查生效否</span></span><br></pre></td></tr></table></figure><p>修改nginx打开文件数 </p><p>在nginx.conf 添加了worker_rlimit_nofile 20480;</p><p>接着测试</p><p>后面测试nginx又报1024 worker_connections are not enough。</p><p>修改nginx.conf中配置 worker_connections 10240 </p><p>再次测试 </p><p>发现有些请求nginx异常</p><p>131175 no live upstreams while connecting to upstream</p><p>发现nginx负载到的其中一个服务没启动。</p><p> 插件</p><p>jp@gc - PerfMon Metrics Collector：服务器性能监测控件，包括CPU，Memory，Network，Ｉ/Ｏ等等（此功能用到在需监听的服务器上启动startAgent）</p><p> 根据需要选择CPU，Memory，Network Ｉ/Ｏ等</p><p><a href="https://jmeter-plugins.org/wiki/PerfMon/">PerfMon wiki</a></p><p>jp@gc - Respose Times Over Time： 响应时间超时，显示每个采样以毫秒为单位的平均响应时间</p><p>jp@gc - Transactions per Second： 每秒事务数，服务器每秒处理的事务数</p><p>jp@gc - Actiive Threads Over Time：不同时间的活动用户数量展示</p><p>jp@gc - Reponse Times Distribution： 显示测试的响应时间分布，X轴显示由时间间隔分组的响应时间，Y轴包含每个区间的样本数 <a href="https://jmeter-plugins.org/wiki/RespTimesDistribution/">Distribution/Percentile Graphs   </a>  </p><p> JMeter分布式并发时，几个问题解决方法，1、每个request的具体response返回。2、禁掉不使用的虚拟机网卡</p><p> <a href="https://www.cnblogs.com/jane4321/p/11013042.html">https://www.cnblogs.com/jane4321/p/11013042.html</a></p><p><a href="https://www.zhihu.com/question/45406520">https://www.zhihu.com/question/45406520</a></p><p><a href="https://www.cnblogs.com/zonlo/p/8422583.html">https://www.cnblogs.com/zonlo/p/8422583.html</a> </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt; 首先使用chrome插件BlazeMeter，录制jmeter请求脚本，导入到jmeter中。&lt;/p&gt;
&lt;p&gt;对需要引用大量的外部数据，如用户名密码，可以添加   配置原件–&amp;gt;CSV 数据文件设置变量，在请求中进行引用。&lt;/p&gt;
&lt;p&gt;对需要引用获取到的请求数据，可
      
    
    </summary>
    
    
      <category term="工作" scheme="http://yoursite.com/categories/%E5%B7%A5%E4%BD%9C/"/>
    
    
      <category term="工作" scheme="http://yoursite.com/tags/%E5%B7%A5%E4%BD%9C/"/>
    
      <category term="Jmeter" scheme="http://yoursite.com/tags/Jmeter/"/>
    
  </entry>
  
  <entry>
    <title>Jmeter压测</title>
    <link href="http://yoursite.com/2019/12/16/%E5%B7%A5%E4%BD%9C/Jmeter%E5%8E%8B%E6%B5%8B/"/>
    <id>http://yoursite.com/2019/12/16/%E5%B7%A5%E4%BD%9C/Jmeter%E5%8E%8B%E6%B5%8B/</id>
    <published>2019-12-15T16:00:00.000Z</published>
    <updated>2020-01-02T02:06:42.000Z</updated>
    
    <content type="html"><![CDATA[<p> 首先使用chrome插件BlazeMeter，录制jmeter请求脚本，导入到jmeter中。</p><p>对需要引用大量的外部数据，如用户名密码，可以添加   配置原件–&gt;CSV 数据文件设置变量，在请求中进行引用。</p><p>对需要引用获取到的请求数据，可以在所需请求后添加  后置处理器–&gt;正则表达式提取器,对变量值进行提取，然后再后续请求中引用。</p><p>使用集合点，阻塞线程，直到指定的线程数量到达后，再一起释放，可以瞬间产生很大的压力。（添加–&gt;定时器–&gt;同步定时器）（可能会导致部分线程组一直不结束）</p><p>压测</p><p>开启5000个线程组时，大量请求报错 java.net.BindException: Address already in use: connect</p><p>原因：可能是由TCP / IP端口耗尽引起的。在非常高的负载下，反复连接到其他服务的服务器可能会耗尽临时端口。 刚刚关闭的端口号在重新使用之前，会保持一段时间的等待状态。如果连接速率足够高，则所有端口最终都将处于等待状态，并且操作系统将无法再将连接绑定到端口。 </p><p>排查：可以使用以下内容确定端口耗尽是否是真正的瓶颈 。</p><p>1、在峰值负载下，运行“ netstat -ano -p tcp”将列出所有正在使用的端口。 </p><p>2、使用“ netsh int ipv4 show dynamicport tcp”监视范围内的可用端口。 </p><p>确定了如是导致的原因，解决</p><p>1、增加动态端口范围，默认情况下，最大值为5000，最多可以将其设置为65534，</p><p>HKLM\System\CurrentControlSet\Services\Tcpip\Parameters\MaxUserPort 。</p><p>2、减少TIME_WAIT 状态 的时间 ，默认为4分钟，可以将其设置为30秒 ，</p><p>HKLM\System\CurrentControlSet\Services\Tcpip\Parameters\TCPTimedWaitDelay 。</p><p>参考：<a href="https://support.pitneybowes.com/VFP06_KnowledgeWithSidebarTroubleshoot?id=kA280000000CgbbCAC&popup=false&lang=en_US">Address already in use: connect” in EngageOne Vault </a></p><p>  接下来测试</p><p>后台服务中报 org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe。 </p><p>主要原因是 客户端先关闭了连接，服务器端没有执行关闭连接的操作。 </p><p>压测时在服务器执行</p><p>netstat -n | awk ‘/^tcp/ {++state[$NF]} END {for(key in state) print key,”\t”,state[key]}’</p><p>查看了下当时tcpip连接的状态，进一步排查。</p><p>这个原因是因为jmeter线程组一直不结束，在jmeter中手动停止了所有线程导致。</p><p>在jmeter请求中也会出现这样的错误java net SocketException: Socket closed</p><p>参考:[java.io.IOException: Broken pipe](<a href="https://blog.csdn.net/zqz_zqz/article/details/52235479">https://blog.csdn.net/zqz_zqz/article/details/52235479</a> N )</p><p>接着测试</p><p>使用nginx进行负载均衡到两个后台服务时，nginx日志发现<code>socket() failed (24: Too many open files) while connecting to upstream</code> </p><p>修改linux打开文件句柄数(可能遇到修改后不生效问题) 参考:<a href="<https://blog.csdn.net/leshami/article/details/8749773">ulimit: open files: cannot modify limit</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/security/limits.conf</span><br><span class="line">root  soft  nproc 16384</span><br><span class="line">root  hard  nproc 16384</span><br><span class="line">root  soft  nofile 65535</span><br><span class="line">root  hard  nofile 65535</span><br><span class="line">root  soft  memlock  4000000</span><br><span class="line">root  hard  memlock  4000000</span><br><span class="line">$ shutdown –r now  <span class="comment">#重启服务器</span></span><br><span class="line">$ <span class="built_in">ulimit</span> -a  <span class="comment">#检查生效否</span></span><br></pre></td></tr></table></figure><p>修改nginx打开文件数 </p><p>在nginx.conf 添加了worker_rlimit_nofile 20480;</p><p>接着测试</p><p>后面测试nginx又报1024 worker_connections are not enough。</p><p>修改nginx.conf中配置 worker_connections 10240 </p><p>再次测试 </p><p>发现有些请求nginx异常</p><p>131175 no live upstreams while connecting to upstream</p><p>发现nginx负载到的其中一个服务没启动。</p><p> 插件</p><p>jp@gc - PerfMon Metrics Collector：服务器性能监测控件，包括CPU，Memory，Network，Ｉ/Ｏ等等（此功能用到在需监听的服务器上启动startAgent）</p><p> 根据需要选择CPU，Memory，Network Ｉ/Ｏ等</p><p><a href="https://jmeter-plugins.org/wiki/PerfMon/">PerfMon wiki</a></p><p>jp@gc - Respose Times Over Time： 响应时间超时，显示每个采样以毫秒为单位的平均响应时间</p><p>jp@gc - Transactions per Second： 每秒事务数，服务器每秒处理的事务数</p><p>jp@gc - Actiive Threads Over Time：不同时间的活动用户数量展示</p><p>jp@gc - Reponse Times Distribution： 显示测试的响应时间分布，X轴显示由时间间隔分组的响应时间，Y轴包含每个区间的样本数 <a href="https://jmeter-plugins.org/wiki/RespTimesDistribution/">Distribution/Percentile Graphs   </a>  </p><p> JMeter分布式并发时，几个问题解决方法，1、每个request的具体response返回。2、禁掉不使用的虚拟机网卡</p><p> <a href="https://www.cnblogs.com/jane4321/p/11013042.html">https://www.cnblogs.com/jane4321/p/11013042.html</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/jmeter-server -Djava.rmi.server.hostname=192.168.1.80</span><br></pre></td></tr></table></figure><p><a href="https://www.zhihu.com/question/45406520">https://www.zhihu.com/question/45406520</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt; 首先使用chrome插件BlazeMeter，录制jmeter请求脚本，导入到jmeter中。&lt;/p&gt;
&lt;p&gt;对需要引用大量的外部数据，如用户名密码，可以添加   配置原件–&amp;gt;CSV 数据文件设置变量，在请求中进行引用。&lt;/p&gt;
&lt;p&gt;对需要引用获取到的请求数据，可
      
    
    </summary>
    
    
      <category term="工作" scheme="http://yoursite.com/categories/%E5%B7%A5%E4%BD%9C/"/>
    
    
      <category term="工作" scheme="http://yoursite.com/tags/%E5%B7%A5%E4%BD%9C/"/>
    
      <category term="Jmeter" scheme="http://yoursite.com/tags/Jmeter/"/>
    
  </entry>
  
</feed>
